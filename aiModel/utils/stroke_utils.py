def _xy(p):
    """
    다양한 포인트 표현을 (x, y) 튜플로 표준화한다.
    지원:
      - dict: {"x": float, "y": float}
      - 시퀀스: (x, y) / [x, y]
      - 속성: p.x, p.y  (예: Offset)
    """
    # dict 스타일
    if isinstance(p, dict):
        return float(p["x"]), float(p["y"])
    # 시퀀스 (tuple/list)
    if isinstance(p, (tuple, list)) and len(p) >= 2:
        return float(p[0]), float(p[1])
    # 속성 접근 (Offset 등)
    if hasattr(p, "x") and hasattr(p, "y"):
        return float(getattr(p, "x")), float(getattr(p, "y"))
    raise TypeError(f"Unsupported point type for {_safe_repr(p)}")

def _safe_repr(p, maxlen=120):
    s = repr(p)
    return s if len(s) <= maxlen else s[:maxlen] + "…"

STROKE_DIRECTION_RULES = {
 'ㄱ': {1: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㄲ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'}, 2: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㄳ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'},
       2: {'DELTA_X': '-', 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㄴ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㄵ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㄶ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'},
       2: {'DELTA_X': None, 'DELTA_Y': None},
       3: {'DELTA_X': None, 'DELTA_Y': None},
       4: {'DELTA_X': None, 'DELTA_Y': None}},
 'ㄷ': {1: {'DELTA_X': '+', 'DELTA_Y': None}, 2: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㄸ': {1: {'DELTA_X': '+', 'DELTA_Y': None},
       2: {'DELTA_X': '+', 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': None},
       4: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㄹ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㄺ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': '+', 'DELTA_Y': '+'},
       4: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㄻ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': '+', 'DELTA_Y': '+'},
       4: {'DELTA_X': None, 'DELTA_Y': '+'},
       5: {'DELTA_X': '+', 'DELTA_Y': '+'},
       6: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㄽ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': '+', 'DELTA_Y': '+'},
       4: {'DELTA_X': '-', 'DELTA_Y': '+'},
       5: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㄾ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': '+', 'DELTA_Y': '+'},
       4: {'DELTA_X': '+', 'DELTA_Y': None},
       5: {'DELTA_X': '+', 'DELTA_Y': '+'},
       6: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㄿ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': '+', 'DELTA_Y': '+'},
       4: {'DELTA_X': '+', 'DELTA_Y': None},
       5: {'DELTA_X': None, 'DELTA_Y': '+'},
       6: {'DELTA_X': None, 'DELTA_Y': '+'},
       7: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅀ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': '+', 'DELTA_Y': '+'},
       4: {'DELTA_X': None, 'DELTA_Y': None},
       5: {'DELTA_X': None, 'DELTA_Y': None},
       6: {'DELTA_X': None, 'DELTA_Y': None}},
 'ㅁ': {1: {'DELTA_X': None, 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅂ': {1: {'DELTA_X': None, 'DELTA_Y': '+'},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': None},
       4: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅃ': {1: {'DELTA_X': None, 'DELTA_Y': '+'},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': None},
       4: {'DELTA_X': '+', 'DELTA_Y': None},
       5: {'DELTA_X': None, 'DELTA_Y': '+'},
       6: {'DELTA_X': None, 'DELTA_Y': '+'},
       7: {'DELTA_X': '+', 'DELTA_Y': None},
       8: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅄ': {1: {'DELTA_X': None, 'DELTA_Y': '+'},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': None},
       4: {'DELTA_X': '+', 'DELTA_Y': None},
       5: {'DELTA_X': '-', 'DELTA_Y': '+'},
       6: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㅅ': {1: {'DELTA_X': '-', 'DELTA_Y': '+'}, 2: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㅆ': {1: {'DELTA_X': '-', 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': '+'},
       3: {'DELTA_X': '-', 'DELTA_Y': '+'},
       4: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㅇ': {1: {'DELTA_X': None, 'DELTA_Y': None}},
 'ㅈ': {1: {'DELTA_X': None, 'DELTA_Y': '+'}, 2: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㅉ': {1: {'DELTA_X': None, 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': '+'},
       3: {'DELTA_X': None, 'DELTA_Y': '+'},
       4: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㅊ': {1: {'DELTA_X': None, 'DELTA_Y': None},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': '+'}},
 'ㅋ': {1: {'DELTA_X': '+', 'DELTA_Y': '+'}, 2: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅌ': {1: {'DELTA_X': '+', 'DELTA_Y': None},
       2: {'DELTA_X': '+', 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅍ': {1: {'DELTA_X': '+', 'DELTA_Y': None},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': None, 'DELTA_Y': '+'},
       4: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅎ': {1: {'DELTA_X': None, 'DELTA_Y': None},
       2: {'DELTA_X': None, 'DELTA_Y': None},
       3: {'DELTA_X': None, 'DELTA_Y': None}},
 'ㅏ': {1: {'DELTA_X': None, 'DELTA_Y': '+'}, 2: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅐ': {1: {'DELTA_X': None, 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅑ': {1: {'DELTA_X': None, 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅒ': {1: {'DELTA_X': None, 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': '+', 'DELTA_Y': None},
       4: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅓ': {1: {'DELTA_X': '+', 'DELTA_Y': None}, 2: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅔ': {1: {'DELTA_X': '+', 'DELTA_Y': None},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅕ': {1: {'DELTA_X': '+', 'DELTA_Y': None},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅖ': {1: {'DELTA_X': '+', 'DELTA_Y': None},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': None, 'DELTA_Y': '+'},
       4: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅗ': {1: {'DELTA_X': None, 'DELTA_Y': '+'}, 2: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅘ': {1: {'DELTA_X': None, 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': None, 'DELTA_Y': '+'},
       4: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅚ': {1: {'DELTA_X': None, 'DELTA_Y': '+'},
       2: {'DELTA_X': '+', 'DELTA_Y': None},
       3: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅛ': {1: {'DELTA_X': None, 'DELTA_Y': '+'},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅜ': {1: {'DELTA_X': '+', 'DELTA_Y': None}, 2: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅝ': {1: {'DELTA_X': '+', 'DELTA_Y': None},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': None},
       4: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅞ': {1: {'DELTA_X': '+', 'DELTA_Y': None},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': '+', 'DELTA_Y': None},
       4: {'DELTA_X': None, 'DELTA_Y': '+'},
       5: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅟ': {1: {'DELTA_X': '+', 'DELTA_Y': None},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅠ': {1: {'DELTA_X': '+', 'DELTA_Y': None},
       2: {'DELTA_X': None, 'DELTA_Y': '+'},
       3: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅡ': {1: {'DELTA_X': '+', 'DELTA_Y': None}},
 'ㅢ': {1: {'DELTA_X': '+', 'DELTA_Y': None}, 2: {'DELTA_X': None, 'DELTA_Y': '+'}},
 'ㅣ': {1: {'DELTA_X': None, 'DELTA_Y': '+'}}}





import unicodedata

# 한글 자모 테이블
CHOSUNG_LIST =  ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ',
                 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ']
JUNGSUNG_LIST = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ',
                 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ']
JONGSUNG_LIST = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ',
                 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ',
                 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ']

def decompose_hangul(syllable):
    """한글 음절을 (초성, 중성, 종성) 으로 분해"""
    code = ord(syllable)
    if not (0xAC00 <= code <= 0xD7A3):
        return syllable  # 한글이 아니면 그대로 반환

    base = code - 0xAC00
    cho = base // (21 * 28)
    jung = (base % (21 * 28)) // 28
    jong = base % 28
    return (CHOSUNG_LIST[cho], JUNGSUNG_LIST[jung], JONGSUNG_LIST[jong])


def check_stroke_directions(practice_syllable, stroke_points):
    phonemes = decompose_hangul(practice_syllable)

    expected_directions = []
    for phoneme in phonemes:
        rules = STROKE_DIRECTION_RULES.get(phoneme, {})
        for i in range(1, len(rules) + 1):
            expected_directions.append(rules[i])

    for i, direction in enumerate(expected_directions):
        start = stroke_points[i * 2]
        end = stroke_points[i * 2 + 1]
        sx, sy = _xy(start)
        ex, ey = _xy(end)
        dx, dy = ex - sx, ey - sy

        if direction["DELTA_X"] in ["+", "-"]:
            if (direction["DELTA_X"] == "+" and dx <= 0) or (direction["DELTA_X"] == "-" and dx >= 0):
                return False, f"{i+1}번째 획의 X방향이 {direction['DELTA_X']}이어야 하는데 그렇지 않음"

        if direction["DELTA_Y"] in ["+", "-"]:
            if (direction["DELTA_Y"] == "+" and dy <= 0) or (direction["DELTA_Y"] == "-" and dy >= 0):
                return False, f"{i+1}번째 획의 Y방향이 {direction['DELTA_Y']}이어야 하는데 그렇지 않음"

    return True, None



